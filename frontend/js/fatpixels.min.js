/**
 * FatPixels: State-of-the-art pixel art animation and drawing. For the rest of us.
 * @author Matías Martínez http://matmartinez.net/
 */(function(g,i,c){function j(q){for(var o=1;o<arguments.length;o++){var p=arguments[o];for(var r in p){if(q[r]===c){q[r]=p[r]}}}return q}function l(o,n){return o.indexOf(n,o.length-n.length)!==-1}function b(n,p){var o=new Image();if(p){o.onload=function(){p(o,n)};o.onerror=function(){p(false)};o.onabort=function(){p(false)}}o.src=n}var k=(function(){return g.requestAnimationFrame||g.webkitRequestAnimationFrame||g.mozRequestAnimationFrame||g.oRequestAnimationFrame||g.msRequestAnimationFrame||function(o,n){g.setTimeout(o,1000/60)}})();function m(p,o){if(!g.requestAnimationFrame&&!g.webkitRequestAnimationFrame&&!(g.mozRequestAnimationFrame&&g.mozCancelRequestAnimationFrame)&&!g.oRequestAnimationFrame&&!g.msRequestAnimationFrame){return g.setInterval(p,o)}var r=new Date().getTime(),q=new Object();function n(){var s=new Date().getTime(),t=s-r;if(t>=o){p.call();r=new Date().getTime()}q.value=k(n)}q.value=k(n);return q}function f(n){g.cancelAnimationFrame?g.cancelAnimationFrame(n.value):g.webkitCancelAnimationFrame?g.webkitCancelAnimationFrame(n.value):g.webkitCancelRequestAnimationFrame?g.webkitCancelRequestAnimationFrame(n.value):g.mozCancelRequestAnimationFrame?g.mozCancelRequestAnimationFrame(n.value):g.oCancelRequestAnimationFrame?g.oCancelRequestAnimationFrame(n.value):g.msCancelRequestAnimationFrame?g.msCancelRequestAnimationFrame(n.value):clearInterval(n)}var d={scale:1,autoplay:true,loop:true,speed:"15fps",};var a=function(n){if(!this.drawWithTarget){return new a(n)}this.options=j(n||{},{},d);this.bitmaps=null;this.bitmapSize={width:0,height:0};this.frames=null;this.frame=0;this.useSprite=this.options.sprite!=c;this.useArrayOfImages=this.options.images!=c};var e=function(n,o){this.buffer=i.createElement("canvas");this.buffer.width=n;this.buffer.height=o};e.prototype.drawInBuffer=function(n){this.buffer.getContext("2d").drawImage(n,0,0)};e.prototype.drawBufferInContext=function(n){n.drawImage(this.buffer,0,0)};a.prototype.renderFrames=function(M,L){var B=this.bitmaps;var D=this.bitmapSize;if(!B||L){var C=this;return C.getBitmaps(function(w,r){C.bitmaps=w;C.bitmapSize=r;C.renderFrames(M,false)})}var u=[];var K=this.options.scale,t=D.width*K,F=D.height*K;var n=i.createElement("canvas");n.width=t;n.height=F;var A=n.getContext("2d");for(var E=0;E<B.length;E++){var J=B[E].data;var p=J.length;A.clearRect(0,0,t,F);for(var s=0;s<D.width;s++){for(var q=0;q<D.height;q++){var o=(s+q*D.width)*4;var z,G,H,I;z=J[o+0];G=J[o+1];H=J[o+2];I=J[o+3];A.fillStyle="rgba("+z+","+G+","+H+","+I+")";A.fillRect(s*K,q*K,K,K)}}var v=new e(t,F);v.drawInBuffer(n);u[E]=v}this.frames=u;if(M){M()}};a.prototype.getBitmaps=function(t){var v=[];var p=[0,0];if(this.useSprite){var w=this.options.sprite;var r=w.url,u=w.direction,q=w.count;b(r,function(y){if(y){var C=y.width,A=y.height;var x=i.createElement("canvas");x.width=C;x.height=A;var F=x.getContext("2d");F.drawImage(y,0,0,C,A);var D,B,G=0,E=0;if(u==="x"){D=y.width/q;B=y.height;G=D}else{D=y.width;B=y.height/q;E=B}p={width:D,height:B};for(var z=0;z<q;z++){v[z]=F.getImageData(G*z,E*z,D,B)}}if(t){t(v,p)}})}else{if(this.useArrayOfImages){var s=this.options.images;var n=s.length;for(var o=0;o<s.length;o++){b(s[o],function(B,x){n--;if(B){var z=B.width;h=B.height;p={width:z,height:h};var A=i.createElement("canvas");A.width=z;A.height=h;var y=A.getContext("2d");y.drawImage(B,0,0,z,h);v[s.indexOf(x)]=y.getImageData(0,0,z,h)}if(n==0&&t){t(v,p)}})}}}};a.prototype.drawWithTarget=function(o){var n=i.createElement("canvas");o.appendChild(n);this.drawWithCanvas(n)};a.prototype.drawWithCanvas=function(p){var o=p.getContext("2d");var n,q,r=true;this.drawWithHandler(function(t,s){if(r){n=t.buffer.width;q=t.buffer.height;p.width=n;p.height=q;r=false}o.clearRect(0,0,n,q);t.drawBufferInContext(o)})};a.prototype.drawWithHandler=function(n){var o=this;o.drawingHandler=n;o.renderFrames(function(){if(o.options.autoplay){o.isAnimating=(o.frames.length>1)}o.needsDisplay()})};a.prototype.drawingHandler=function(o,n){console.warn("FatPixels: Empty implementation for -drawingHandler.")};a.prototype.needsDisplay=function(){var s=this;var r=s.isAnimating,p=s.frames,o=s.frame;var n=s.options.onAnimation;var q=s.options.speed;if(typeof q=="string"||q instanceof String){if(l(q,"fps")){q=1000/parseFloat(q)}else{if(l(q,"ms")){q=parseFloat(q)}else{if(l(q,"s")){q=parseFloat(q)*1000}}}}if(!s.drawingInterval){s.drawingInterval=m(function(){o++;if(o==p.length){o=0;if(s.options.loop==false){setTimeout(function(){s.setAnimating(false)},1)}}s.drawingHandler(p[o],o);if(n){n(o)}},q)}if(!r){f(s.drawingInterval);delete s.drawingInterval}s.drawingHandler(p[o],o)};a.prototype.setAnimating=function(n){if(n!=this.isAnimating){this.isAnimating=n;this.needsDisplay()}};a.prototype.setFrame=function(n){if(n!=this.frame&&n<this.frames.length){this.frame=n;this.needsDisplay()}};a.prototype.pause=function(){this.setAnimating(false)};a.prototype.play=function(){this.setAnimating(true)};a.prototype.stop=function(){this.setAnimating(false);this.setFrame(0)};if(typeof jQuery=="function"){(function(n){n.fn.FatPixels=function(o){this.each(function(){var q=n(this),p=q.data();if(p.pixels){p.pixels.remove();delete p.pixels}if(o!==false){p.pixels=new a(o);if(this.tagName.toLowerCase()==="canvas"){p.pixels.drawWithCanvas(this)}else{p.pixels.drawWithTarget(this)}}return p.pixels});return this}})(jQuery)}if(typeof define=="function"&&define.amd){define(function(){return a});define(function(){return e})}else{g.FatPixels=a;g.FatFrame=e}})(window,document);